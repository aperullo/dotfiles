#!/bin/bash

# Save this file as ~/.config/yadm/bootstrap and make it executable. It will
# execute all executable files (excluding templates and editor backups) in the
# ~/.config/yadm/bootstrap.d directory when run.
# Optionally, pass a filename as the first argument to run only that file.

set -e -o pipefail

# Directory to look for bootstrap executables in
BOOTSTRAP_D="${BASH_SOURCE[0]}.d"

source "$(dirname "$(realpath "$0")")/funcs"

is_installed "yadm"

if [[ ! -d "$BOOTSTRAP_D" ]]; then
    echo "Error: bootstrap directory '$BOOTSTRAP_D' not found" >&2
    exit 1
fi

if [[ $# -gt 0 ]]; then
    BOOTSTRAP_FILE="$BOOTSTRAP_D/$1"
    if [[ ! -f "$BOOTSTRAP_FILE" ]]; then
        echo "Error: bootstrap file '$BOOTSTRAP_FILE' not found" >&2
        exit 1
    fi
    if [[ ! -x "$BOOTSTRAP_FILE" ]]; then
        echo "Error: bootstrap file '$BOOTSTRAP_FILE' is not executable" >&2
        exit 1
    fi
    echo "Running $BOOTSTRAP_FILE"
    if ! "$BOOTSTRAP_FILE"; then
        echo "Error: bootstrap '$BOOTSTRAP_FILE' failed" >&2
        exit 1
    fi
else
    find -L "$BOOTSTRAP_D" -type f | sort | while IFS= read -r bootstrap; do
        if [[ -x "$bootstrap" && ! "$bootstrap" =~ "##" && ! "$bootstrap" =~ "~$" ]]; then
            echo "Running $bootstrap"
            if ! "$bootstrap"; then
                echo "Error: bootstrap '$bootstrap' failed" >&2
                exit 1
            fi
        fi
    done
fi
